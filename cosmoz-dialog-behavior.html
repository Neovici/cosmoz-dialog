<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<script>

/**
`Cosmoz.DialogBehavior`
*/
(function () {
	'use strict';

	window.Cosmoz = window.Cosmoz || {};
	const _async = window.requestIdleCallback || window.requestAnimationFrame || Polymer.Base.async;

	/**
	 * @polymerBehavior Cosmoz.DialogBehavior
	*/
	Cosmoz.DialogBehaviorImpl = {
		properties: {
			modal: {
				type: Boolean
			},

			withBackdrop: {
				type: Boolean
			},

			/**
			 * Set to true to disable auto-focusing the overlay or child nodes with
			 * the `autofocus` attribute` when the overlay is opened.
			 */
			noAutoFocus: {
				type: Boolean,
				value: false
			},
		},

		hostAttributes: {
			'role': 'dialog',
			'tabindex': '-1'
		},

		// The generated paper-dialog element
		_paperDialog: null,

		_templateInstance: null,

		_dialogEventsHandler: null,

		_pendingProps: null,

		created: function () {
			this._dialogEventsHandler = this._handlePaperDialogEvents.bind(this);
			this._pendingProps = {};
			this._spawn = this._spawn.bind(this);
			this._spawnSteps = [this._createDialog, this._createInstance];
		},

		attached: function () {
			this._observer = Polymer.dom(this).observeNodes(this._onNodesChange);
		},

		detached: function () {
			if (this._observer) {
				Polymer.dom(this).unobserveNodes(this._observer);
				this._observer = null;
			}
			this._detachDialog();
		},

		_spawn() {
			const step = this._spawnSteps.shift();
			if (!step) {
				return;
			}
			step.call(this);
			_async(this._spawn);
		},
		/**
		 * Get the generated paper-dialog element
		 */
		get paperDialog() {
			return this._paperDialog;
		},

		open: function () {
			if (!this._userTemplate) {
				return;
			}

			this._spawnSteps.splice(0).forEach(step => step.call(this));

			this._attachDialog();
			this._paperDialog.open();
		},

		_attachDialog: function () {
			if (!this._paperDialog.parentNode) {
				Polymer.dom(document.body).appendChild(this._paperDialog);
			}
		},

		_detachDialog: function () {
			if (this._paperDialog != null && this._paperDialog.parentNode) {
				Polymer.dom(this._paperDialog.parentNode).removeChild(this._paperDialog);
			}
		},


		close: function () {
			if (this._paperDialog != null) {
				this._paperDialog.close();
			}
		},

		fit: function () {
			if (this._paperDialog != null && this._paperDialog.opened) {
				this._paperDialog.fit();
			}
		},

		refit: function () {
			if (this._paperDialog != null && this._paperDialog.opened) {
				this._paperDialog.refit();
			}
		},

		center: function () {
			if (this._paperDialog != null && this._paperDialog.opened) {
				this._paperDialog.center();
			}
		},

		_ensureTemplatized: function () {
			if (this.ctor || !this._userTemplate) {
				return;
			}
			this._instanceProps = {};
			this._parentModel = true;
			this.templatize(this._userTemplate);
		},

		_onNodesChange() {
			if (this._userTemplate) {
				return;
			}
			const template = this.queryEffectiveChildren('template');

			if (!template) {
				console.warn('cosmoz-dialog-behavior requires a template');
				this._spawnSteps.splice(0);
			}
			this._userTemplate = template;
			this._ensureTemplatized();
			_async(this._spawn);

		},

		_createDialog: function () {
			if (!this._userTemplate) {
				return;
			}

			var dialog = document.createElement('paper-dialog');
			dialog.modal = this.modal;

			if (!this.modal) {
				dialog.withBackdrop = this.withBackdrop;
			}

			dialog.noAutoFocus = this.noAutoFocus;

			dialog.addEventListener('iron-overlay-opened', this._dialogEventsHandler);
			dialog.addEventListener('iron-overlay-closed', this._dialogEventsHandler);

			this._paperDialog = dialog;
			return dialog;
		},

		_createInstance: function () {
			if (!this._paperDialog) {
				return;
			}
			const instance = this.stamp(),
				props = this._pendingProps;

			Object.keys(props).forEach(key => {
				const value = props[key];
				if (instance.forwardHostProp) {
					instance.forwardHostProp(key, value);
					return;
				}
				instance[key] = value;
			});

			this._pendingProps = {};

			this._templateInstance = instance;
			Polymer.dom(this._paperDialog).appendChild(instance.root);

			if (instance._flushProperties) {
				instance._flushProperties(true);
			}

			return instance;
		},

		_handlePaperDialogEvents: function (event) {
			this.fire(event.type);
		},

		_forwardParentProp: function (prop, value) {
			const instance = this._templateInstance;
			if (!instance) {
				this._pendingProps[prop] = value;
				return;
			}
			instance[prop] = value;
		},

		_forwardHostPropV2: function (prop, value) {
			const instance = this._templateInstance;
			if (!instance) {
				this._pendingProps[prop] = value;
				return;
			}
			instance.forwardHostProp(prop, value);
		},

		_forwardParentPath: function (path, value) {
			const instance = this._templateInstance;
			if (instance) {
				instance.notifyPath(path, value, true);
			}
		}
	};

	Cosmoz.DialogBehavior = [Cosmoz.DialogBehaviorImpl, Polymer.Templatizer];

})();

</script>
