<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<!--

`<cosmoz-dialog>` is a wrapper element for `<paper-dialog>`, but that will append a paper-dialog to a `<cosmoz-dialog-container>`
container element or to the `<body>` element if no container is available.
This is an attempt to workaround stacking context issues with dialogs.

Content of the `<paper-dialog>` must be specified in a `<template>` element.

@demo demo/index2.html Dialog2 Demo
-->
<dom-module id="cosmoz-dialog2">
	<template>
		<div hidden>
			<slot></slot>
		</div>
	</template>
</dom-module>
<script>

	(function () {

		Polymer({

			is: 'cosmoz-dialog2',

			properties: {
				modal: {
					type: Boolean
				},

				withBackdrop: {
					type: Boolean
				},
			},

			behaviors: [
				Polymer.Templatizer
			],

			_paperDialog: null,

			_dialogTemplateInstance: null,

			_container: null,

			ready: function () {
				this._instanceProps = {};
			},

			detached: function () {
				if (this._paperDialog !== null && this._paperDialog.parentNode) {
					Polymer.dom(this._paperDialog.parentNode).removeChild(this._paperDialog);
				}
				this._container = null;
			},

			attached: function () {
				this.fire('cosmoz-dialog-attached', { dialog: this });
				if (!this._container) {
					this._container = document.body;
				}

				if (this._paperDialog === null) {
					this._paperDialog = this._createDialog();
				}
			},

			get paperDialog() {
				return this._paperDialog;
			},

			open: function () {
				if (this._paperDialog === null) {
					// Missing template in cosmoz-dialog
					return;
				}
				if (!this._paperDialog.parentNode) {
					Polymer.dom(this._container).appendChild(this._paperDialog);
				}
				this._paperDialog.open();
			},

			close: function () {
				if (this._paperDialog !== null) {
					this._paperDialog.close();
				}
			},

			fit: function () {
				if (this._paperDialog !== null && this._paperDialog.opened) {
					this._paperDialog.fit();
				}
			},

			_createDialog: function () {
				var dialog = document.createElement('paper-dialog'),
					template;
				if (!this.ctor) {
					template = Polymer.dom(this).querySelector('template');
					if (!template) {
						console.warn('cosmoz-dialog without template', this);
						return null;
					}

					this.templatize(template);
				}

				this._dialogTemplateInstance = this.stamp();
				Polymer.dom(dialog).appendChild(this._dialogTemplateInstance.root);

				dialog.modal = this.modal;
				if (!this.modal) {
					dialog.withBackdrop = this.withBackdrop;
				}

				return dialog;
			},

			_forwardParentProp: function (prop, value) {
				if (this._dialogTemplateInstance) {
					this._dialogTemplateInstance[prop] = value;
				}
			},

			_forwardParentPath: function (path, value) {
				if (this._dialogTemplateInstance) {
					this._dialogTemplateInstance.notifyPath(path, value, true);
				}
			},
		});

	})();

</script>
